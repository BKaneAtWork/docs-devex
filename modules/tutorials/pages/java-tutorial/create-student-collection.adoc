= Create Student Records
:description: Use the SDK to connect to Couchbase and create student records.
:page-topic-type: tutorial
:page-pagination: full
:imagesdir: ../../images

[abstract]
{description}

[#connect-to-the-database]
== Connect to the Database

To connect to the database:

. Go to your `java` directory and create a new file called `ConnectStudent.java`.
+
....
ðŸ“‚ ~ (your home directory)
  ðŸ“‚ student
    ðŸ“ƒ pom.xml
    ðŸ“‚ src
      ðŸ“‚ main
        ðŸ“‚ java
          ðŸ“ƒ ConnectStudent.java â¬… here!
....
+
. Paste the following code block into your `ConnectStudent.java` file:
+
[source, java]
----
import com.couchbase.client.java.Bucket;
import com.couchbase.client.java.Cluster;
import com.couchbase.client.java.Collection;
import com.couchbase.client.java.Scope;

import java.time.Duration;

public class ConnectStudent {

    public static void main(String[] args) {

        /* 
            Calling `Cluster.connect` creates a channel to the named server 
            (in this case, `localhost` is running on your local machine)
            and supplies your username and password to authenticate the connection.
        */
        Cluster cluster = Cluster.connect("localhost",
                "Administrator", "password");    

        /*
            The `cluster.bucket` retrieves the bucket you set up when you
            xref:tutorial-install-server.adoc[installed the Couchbase server].
        */
        Bucket bucket = cluster.bucket("student-bucket");    

        /*
            Most of the Couchbase APIs are non-blocking. When you call one of them,
            your application carries on and continues to perform other actions while the 
            function you called executes. When the function has finished executing, it sends 
            a notification to the caller and the output of the call is processed.

            While this usually works, in this code sample the application carries on without
            waiting for the bucket retrieval to complete after you make the call to `cluster.bucket`.
            This means that you now have to try to retrieve the scope from a bucket object that
            has not been fully initialized yet.

            To fix this, you can use the `waitUntilReady` call. This call forces the application
            to wait until the bucket object is ready.
        */
        bucket.waitUntilReady(Duration.ofSeconds(10));    

        /*
            The `bucket.scope` retrieves the `art-school-scope` from the bucket.
        */
        Scope scope = bucket.scope("art-school-scope");    

        /*
            The `scope.collection` retrieves the student collection from the scope.
        */
        Collection student_records = scope.collection("student-record-collection");    

        /*
            The following line is a check to make sure the collection is connected and
            retrieved when you run the application. You can see the output using maven.
        */
        System.out.println("The name of this collection is " + student_records.name());    

        /*
            Like with all database systems, it's good practice to disconnect from the Couchbase
            cluster after you have finished working with it.
        */
        cluster.disconnect();    
    }
}
----
+
[IMPORTANT]
====
You must re-run `mvn install` in your `student` directory whenever you make a change to a java file to rebuild the application. 
====
+
. Open a terminal window and navigate to your `student` directory.
. Run the command `mvn install` to pull in all the dependencies and rebuild your application.
. Run the following command to check that the connection works:
+
[source, sh]
----
mvn exec:java -Dexec.mainClass="ConnectStudent" -Dexec.cleanupDaemonThreads=false
----
+
If the connection is successful, the collection name outputs in the console log.
+
image::student-record-collection-console-output.png[alt="Console showing successful connection to server"]


== Create a Student Record

After successfully connecting to the database, you can create a student record in the form of a JSON document inserted into the `student-record-collection`.

To create a student record:

. In your `java` directory, create a new file called `InsertStudent.java`.
. Paste the following code block into your `InsertStudent.java` file:
+
[source, java]
----
import com.couchbase.client.java.Bucket;
import com.couchbase.client.java.Cluster;
import com.couchbase.client.java.Collection;
import com.couchbase.client.java.Scope;
import com.couchbase.client.java.json.JsonObject;

import java.time.Duration;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;

public class InsertStudent {

    public static void main(String[] args) {

        Cluster cluster = Cluster.connect("localhost",
                "Administrator", "password");

        Bucket bucket = cluster.bucket("student-bucket");
        bucket.waitUntilReady(Duration.ofSeconds(10));
        Scope scope = bucket.scope("art-school-scope");
        Collection student_records = scope.collection("student-record-collection");    

        /*
            Includes a class of functionality for creating and manipulating data 
            in JSON format. This `JsonObject` class creates and populates the student 
            record.
        */
        JsonObject hilary = JsonObject.create()
                .put("name", "Hilary Smith")
                .put("date-of-birth",
                        LocalDate.of(1980, 12, 21)
                                .format(DateTimeFormatter.ISO_DATE));   


        /*
            The `upsert` function inserts or updates documents in a collection.
            The first parameter is a unique ID for the document, similar to a 
            primary key used in a relational database system.

            If the `upsert` call finds a document with a matching ID in the collection,
            it updates the document. If there is no matching ID, it creates a new document.
        */
        student_records.upsert("000001", hilary);    

        cluster.disconnect();
    }
}
----
+
. Open a terminal window and navigate to your `student` directory.
. Run the command `mvn install` to pull in all the dependencies and rebuild your application.
. Run the following command to insert the student record into the collection:
+
[source, sh]
----
mvn exec:java -Dexec.mainClass="InsertStudent" -Dexec.cleanupDaemonThreads=false
----
+
. Go to your Couchbase cluster in your browser and check the `student-record-collection` for the new student record you just added.
+
image::new-student-record.png[alt="Student added to the student-record-collection in the cluster"]


== Troubleshooting

When connecting to the database and creating a student record, you might get errors in your console.

* If you get an authentication error, confirm that the username and password in your `ConnectStudent.java` and `InsertStudent.java` files match the username and password you used when setting up the Couchbase cluster in your browser.
* If you get the error `DnsSrvLookupFailedEvent`, which tells you to specify an IP address, go to your `ConnectStudent.java` and `InsertStudent.java` files and replace `localhost` with the IP address of your local Couchbase Server.
* For any other errors, run `mvn install` and try the original command again.


== Next Steps

After connecting to the database and creating a student record, you can xref:java-tutorial/create-course-collection.adoc[add course records to your database].