= ROLLBACK TRANSACTION
:description: The ROLLBACK TRANSACTION statement enables you to rollback a transaction.
:page-topic-type: reference
:imagesdir: ../../assets/images

// Cross-references
:transactions: xref:n1ql:n1ql-language-reference/transactions.adoc
:preparation: xref:n1ql:n1ql-language-reference/transactions.adoc#preparation

// Related links
:overview: xref:server:learn:data/transactions.adoc
:begin-transaction: xref:n1ql-language-reference/begin-transaction.adoc
:set-transaction: xref:n1ql-language-reference/set-transaction.adoc
:savepoint: xref:n1ql-language-reference/savepoint.adoc
:commit-transaction: xref:n1ql-language-reference/commit-transaction.adoc
:rollback-transaction: xref:n1ql-language-reference/rollback-transaction.adoc

[abstract]
{description}

== Purpose

The `ROLLBACK TRANSACTION` statement enables you to rollback an ACID transaction.
You can rollback the entire transaction, or rollback to a previous savepoint.
Refer to {transactions}[] for further information.

This statement may only be used within a transaction.

include::partial$n1ql-language-reference/transaction-id.adoc[]

When you rollback the entire transaction, this statement removes all savepoints within the transaction.

ifdef::flag-devex-command-line[]
NOTE: If you are using the cbq shell, and a transaction fails for any reason, you must use the `ROLLBACK TRANSACTION` statement to remove the transaction context and reset the transaction ID.
endif::flag-devex-command-line[]

== Syntax

[source,ebnf]
----
include::partial$grammar/tcl.ebnf[tag=rollback-transaction]
----

image::n1ql-language-reference/rollback-transaction.png["Syntax diagram: refer to source code listing", align=left]

The `WORK`, `TRAN`, and `TRANSACTION` keywords are synonyms.
These keywords are optional; you may include one of these keywords, or omit them entirely.

=== Rollback to a Savepoint

The `TO SAVEPOINT` clause enables you to rollback to a specified savepoint.
This clause is optional.
If omitted, the entire transaction is rolled back.

savepointname::
An identifier specifying a name for the savepoint.

== Examples

If you want to try these examples, first refer to {preparation}[Preparation] to set up your environment.

[[ex-1]]
.Rollback a transaction
====
// Line highlighting doesn't work with highlight.js.
// Markup for future use [source,n1ql,highlight=47..48;57..58]

.Transaction
[source,sqlpp,subs=macros]
----
include::example$transactions/rollback-transaction-q1.n1ql[]
----

.Results
[source,json]
----
include::example$transactions/rollback-transaction-r1.jsonc[]
----

<.> Before setting the second savepoint, the booking document has user `"0"`, name `"Maurice Moss"`.
<.> After setting the second savepoint and performing an update, the booking document has user `"1"`, name `"Jen Barber"`.
<.> After rolling back to the second savepoint, the booking document again has user `"0"`, name `"Maurice Moss"`.
====

[[ex-2]]
.Check the result of <<ex-1>>
====
Check the result of rolling back the transaction.

.Query
[source,sqlpp]
----
SELECT b.*, u.name
FROM bookings b
JOIN users u
ON b.`user` = META(u).id
WHERE META(b).id = "bf7ad6fa-bdb9-4099-a840-196e47179f03";
----

.Results
[source,json]
----
{
  "results": []
}
----

Notice the booking document no longer exists.
====

== Related Links

* For an overview of Couchbase transactions, refer to {overview}[].
* To begin a transaction, refer to {begin-transaction}[].
* To specify transaction settings, refer to {set-transaction}[].
* To set a savepoint, refer to {savepoint}[].
* To commit a transaction, refer to {commit-transaction}[].
* Blog post: https://blog.couchbase.com/transactions-n1ql-couchbase-distributed-nosql/[Couchbase Transactions: Elastic, Scalable, and Distributed^].